<html><body>
      <img id="brushImg" src="brush.png" style="display: none">
      <img id="bgImg" src="paper_sketch.png"  style="display: none">
       <object id="wtPlugin" type="application/x-wacomtabletplugin">
          <param name="onload" value="pluginLoaded" />
      </object>

      <script src="ligthgl.js"></script>
      <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
      <script id="vertex-brush" type="x-shader/x-vertex">
        attribute vec4 vertexPosition;
        uniform mat4 mvp;
        void main()
        {
            //gl_Position = gl_ModelViewProjectionMatrix * vertexPosition;
            gl_Position = mvp * vertexPosition;
            gl_PointSize = 10.0;//brushSize*float(4)*(1.0+tiltValue/2.0);
        }
      </script>

      <script id="fragment-brush" type="x-shader/x-fragment">
        uniform sampler2D texture;
        void main()
        {
          //gl_FragColor = vec4(0,0,0,1.0);
          gl_FragColor = vec4(0,0,0,0.2) * texture2D(texture, gl_PointCoord);// - destColor;
        }
      </script>

    <script id="vertex-renderTexture" type="x-shader/x-vertex">
    attribute vec3 vertexPosition;
    varying vec2 coord;
    uniform mat4 mvp;
    void main(){
    coord = gl_TexCoord.xy;
    gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;
    //gl_Position = gl_ModelViewProjectionMatrix * vertexPosition;
    //gl_Position = mvp * gl_Vertex;
    }
    </script>

    <script id="fragment-renderTexture" type="x-shader/x-fragment">
    uniform sampler2D texture;
    varying vec2 coord;
    void main(){
    gl_FragColor = texture2D(texture, coord)*vec4(1,1,1,1);
    }
    </script>
      <script>
        
      $('#document').ready(function()
      {
        //document.body.style.zoom="100%";
      var angle = 0;
      var gl = GL.create({preserveDrawingBuffer: true,'alpha':true});
      //gl.fullscreen({ camera: false,paddingLeft: 10, paddingBottom: 10,paddingTop:10,paddingRight:10 });
      
      document.body.appendChild(gl.canvas);
      document.body.style.overflow = 'hidden';
      
      
      var width = gl.canvas.width;
      var height = gl.canvas.height;
      console.log(width);
      console.log(height);
      var mesh = GL.Mesh.plane({ coords: true });
      //
      mesh.vertices = [[0, 0, 0], [width, 0, 0], [0, height, 0], [width, height, 0]];
      var renderTexture = new GL.Texture(width, height);

      var texture = GL.Texture.fromURL('brush.png');
      var bgTexture = GL.Texture.fromURL('paper_sketch.png');

      var vertBrush = document.getElementById("vertex-brush");
      var fragBrush = document.getElementById("fragment-brush");
      
      var vertRenderTexture = document.getElementById("vertex-renderTexture");
      var fragRenderTexture = document.getElementById("fragment-renderTexture");
      var vertexShader = new GL.Shader(vertBrush.text,fragBrush.text);
      var shader = new GL.Shader(vertRenderTexture.text,fragRenderTexture.text);
      var mvp = GL.Matrix.ortho(0, width, 0, height, -1,1).m;

      //var mvp = GL.Matrix.translate(0,0,-2);
      //changeBrush();
      /*
      function PaintPoint(pos){
        this.position = pos;//Vector
        this.force = 1;//float
        this.altitude = 0;//float
        this.azimuth = GL.Vector(0,0);
        this.velocity = 0;
      }*/
      gl.onupdate = function(seconds) {
        angle += 45 * seconds;
      };
      gl.scale(2,2,2);
      
      //gl.fullscreen({ fov: 45, near: 0.1, far: 1000 });
      function drawStroke(pos)
      {
        texture.bind(0);
        renderTexture.drawTo(function() {
          //gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
          //gl.clearColor(1,1,1,1);
          gl.enable(gl.BLEND);
          gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);
          gl.loadIdentity();
          gl.translate(0, 0, -1);
          
          var vertices = new GL.Buffer(gl.ARRAY_BUFFER, Float32Array);
          //vertices.data = [[tt, 0, 0,1], [1, 0, 0,1], [0, 1, 0,1], [1, 1, 0,1]];
          
          //var p1 = [0,0,0];
          //var p2 = [1,1,0];
          var pts = interpolatePoints(lastPos,pos);
          vertices.data = vertices.data.concat(pts);
          //console.log(vertices.data);
          vertices.compile();
          
          var vertexBuffers = {'vertexPosition':vertices};
          vertexShader.drawBuffers(vertexBuffers, null, gl.POINTS);
          vertexShader.uniforms({'texture': 0,'mvp':mvp});

        });
        texture.unbind(0);
        //gl.ondraw();
        renderScene();
      }
      function interpolatePoints(spArray,epArray)
      {
        sp = new GL.Vector.fromArray(spArray);
        ep = new GL.Vector.fromArray(epArray);

        var points = [];
        var size = 1;
        var kBrushPixelStep = size*3;
        var dis = ep.subtract(sp).length();
        //console.log(dis);
        var pnum = Math.ceil(dis / kBrushPixelStep);
        //console.log(pnum);
        var count = Math.max(pnum,1);
        count = 1;
        //console.log(count);
        
        for(var i =0;i<=count;i+=0.1)
        {
          var v = GL.Vector.lerp(sp,ep,i/count);

          points.push([v.x,v.y,v.z,1]);
        }
        //drawStroke([0,0,0],[1,1,0]);
        //console.log(points);
        return points;
      }
      var clearCanvas = function()
      {
          renderTexture.drawTo(function() {
              gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
              gl.clearColor(1,1,1,1);
          });
          renderScene();
      }
      var renderScene = function()
      {
          gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
          gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);          
          gl.enable(gl.BLEND);
          gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);

          drawBG();
          drawRenderTexture();
          //scissorTest();

          //drawTest();
      }
      var scissorTest = function()
      {
        gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
    
        // Draw a 1 pixel border around the edge using 
        // the scissor test since it's easier than setting up
        // a lot of stuff
        gl.clearColor(1, 0, 0, 1);  // red
        gl.disable(gl.SCISSOR_TEST);
        gl.clear(gl.COLOR_BUFFER_BIT);
          
        gl.enable(gl.SCISSOR_TEST);
        gl.scissor(1, 1, gl.canvas.width - 2, gl.canvas.height - 2);
        gl.clearColor(0, 0, 1, 1);  // blue
        gl.clear(gl.COLOR_BUFFER_BIT);
      }
      var drawTest = function()
      {
          texture.bind(0);
          shader.uniforms({
            'renderTexture':0,'mvp':mvp
          }).draw(mesh);
          texture.unbind(0);
      }
      var drawRenderTexture = function()
      {
          renderTexture.bind(0);
          shader.uniforms({
            'renderTexture':0,'mvp':mvp
          }).draw(mesh);
          renderTexture.unbind(0);
      }

      function drawBG()
      {
          bgTexture.bind(0);
          shader.uniforms({
              'renderTexture': 0,'mvp':mvp
          }).draw(mesh);
          bgTexture.unbind(0);
      }
      var x = 0;
      
      gl.ondraw = function() {
        x+=0.1;

        pos[0].x = x;
        //drawStroke(lastPos,pos);
        //renderScene();
        lastPos = pos;
      };
      //clearCanvas();
      var pos = [0,0,0]; 
      var lastPos = [0,0,0]; 
      
      $(window).bind('mousemove', mousemove);
      function mousemove(e){
        var o2, x, y;
        x = e.offsetX;
        y = e.offsetY;
        //console.log(e.offsetX);
        //console.log(e.offsetY);
        //var pos = [(x-width/2)/width,1-(height/2-y)/height,0];
        var w = width;
        var h = height;
        //var pos = [(e.offsetX-w/2)/w,-(e.offsetY-h/2)/h,0];
        var pos = [x,height-y];
        //console.log(gl.canvas.width);
        //console.log(gl.canvas.height);
        //var pos = [Math.random()-0.5,Math.random()-0.5,0];
        drawStroke(pos);
        lastPos = pos;
      }
        /*
        var glcanvas;
        $('#document').ready(function()
        {
          glcanvas = new GLCanvas();
          
          glcanvas.renderScene();

        })*/
        //gl.animate();
      });
      </script>
    </body></html>